<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" type="image/png" href="images/apple-touch-icon-180x180.png">
    <link rel="icon" type="image/png" href="images/icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link href="sheet.css" rel="stylesheet">
    <title>Ona Real. Web App</title>
</head>

<!-- éš ã‚Œæ€œå¸ -->
<body>
    <div class="display">
        <div class="nav-control">
            <div class="control-button">
                <a href="deluser.html"><img src="images/left.png"></a>
            </div>
            <div class="logo">
                <a href="javascript:load();"><img src="images/logo.png"></a>
            </div>
            <div class="control-button">
                <a href="upload.html"><img src="images/dummy.png"></a>
            </div>
        </div>
        <div class="sortbar">
            <select id="sortselect">
                <option value="newest" selected>æ–°ã—ã„é †</option>
                <option value="oldest">å¤ã„é †</option>
                <option value="popular">äººæ°—é †</option>
                <option value="random">ã‚·ãƒ£ãƒƒãƒ•ãƒ«</option>
            </select>
        </div>
        <div class="main" id="main">
            <p>Click on the OnaReal logo to get the post</p>
            <div id="pwa-install-prompt" style="display:none; background:#222; color:white; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.08); padding:1.5em 2em; margin:2em 0; text-align:center;">
                <h2 style="font-size:1.2em; margin-bottom:0.5em;">ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™</h2>
                <p>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚„ã€Œã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ãƒœã‚¿ãƒ³ã‹ã‚‰<br>ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¢ãƒ—ãƒªã¨ã—ã¦ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚</p>
                <button id="install-btn" style="margin-top:1em;">Install</button>
            </div>
            <div id="notification-prompt" style="display:none; background:#222; color:white; border-radius:12px; padding:1.5em 2em; margin:2em 0; text-align:center;">
                <h2 style="font-size:1.2em; margin-bottom:0.5em;">é€šçŸ¥ã‚’æœ‰åŠ¹ã«</h2>
                <p>iPhoneã§æœ€æ–°ã®æŠ•ç¨¿é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯ã€é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
                <button id="notification-btn" style="margin-top:1em; background:#4CAF50; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">é€šçŸ¥ã‚’è¨±å¯</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-messaging-compat.js"></script>
    
    <!-- Firebaseè¨­å®š -->
    <script src="/OnaReal/firebase-config.js"></script>
    
    <!-- é€šçŸ¥æ©Ÿèƒ½ -->
    <script src="/OnaReal/global-notification.js"></script>
    <script src="/OnaReal/notification.js"></script>
    <script src="script.js"></script>
    <script src="index.js"></script>
    
    <script>
        let deferredPrompt;
        const pwaPrompt = document.getElementById('pwa-install-prompt');
        const installBtn = document.getElementById('install-btn');
        let swRegistration = null;
        
        // Service Workerç«¶åˆé˜²æ­¢: æ—¢å­˜SWã‚’å…¨ã¦unregister
        async function unregisterAllServiceWorkers() {
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const reg of registrations) {
                    try {
                        await reg.unregister();
                        console.log('Service Worker unregistered:', reg);
                    } catch (e) {
                        console.warn('Service Worker unregister failed:', e);
                    }
                }
            }
        }

        // Service Workerç™»éŒ²
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const options = { updateViaCache: 'none' };
                    swRegistration = await navigator.serviceWorker.register('/OnaReal/firebase-messaging-sw.js', options);
                    console.log('Service Worker registered:', swRegistration);
                    updateDebugInfo('Service Workerç™»éŒ²æˆåŠŸ');
                    
                    if (swRegistration.active) {
                        console.log('Service Worker is active');
                        updateDebugInfo('Service Workerã‚¢ã‚¯ãƒ†ã‚£ãƒ–');
                    } else {
                        console.log('Waiting for Service Worker to activate');
                        swRegistration.addEventListener('updatefound', () => {
                            const newWorker = swRegistration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('Service Worker activated');
                                    updateDebugInfo('Service Workerã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–å®Œäº†');
                                }
                            });
                        });
                    }
                } catch (error) {
                    console.error('Service Workerç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                    updateDebugInfo(`Service Workerç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
        }
        
        // æ›´æ–°é€šçŸ¥ã‚’è¡¨ç¤º
        function showUpdateNotification() {
            const updateDiv = document.createElement('div');
            updateDiv.innerHTML = `
                <div style="position: fixed; top: 10px; right: 10px; background: #2196F3; color: white; 
                     padding: 15px; border-radius: 8px; z-index: 10002; box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
                     max-width: 300px;">
                    <h4 style="margin: 0 0 10px 0;">ğŸ”„ æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒåˆ©ç”¨å¯èƒ½</h4>
                    <p style="margin: 0 0 15px 0; font-size: 14px;">ã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã—ã¦æœ€æ–°ã®æ©Ÿèƒ½ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„</p>
                    <button onclick="updateApp()" 
                            style="background: white; color: #2196F3; border: none; 
                                   padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                        æ›´æ–°
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: transparent; color: white; border: 1px solid white; 
                                   padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        å¾Œã§
                    </button>
                </div>
            `;
            document.body.appendChild(updateDiv);
        }
        
        // ã‚¢ãƒ—ãƒªã‚’æ›´æ–°
        function updateApp() {
            if (swRegistration && swRegistration.waiting) {
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
                updateDebugInfo('ã‚¢ãƒ—ãƒªæ›´æ–°å®Ÿè¡Œ');
            }
        }
        
        // æ‰‹å‹•ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
        async function forceCacheUpdate() {
            if (swRegistration) {
                try {
                    const channel = new MessageChannel();
                    channel.port1.onmessage = (event) => {
                        if (event.data.type === 'CACHE_UPDATED') {
                            showCacheUpdateSuccess();
                            updateDebugInfo('ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°æˆåŠŸ');
                        } else if (event.data.type === 'CACHE_UPDATE_ERROR') {
                            showCacheUpdateError();
                            updateDebugInfo('ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚¨ãƒ©ãƒ¼');
                        }
                    };
                    swRegistration.active.postMessage({ type: 'CACHE_UPDATE' }, [channel.port2]);
                } catch (error) {
                    console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                    updateDebugInfo(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°æˆåŠŸ
        function showCacheUpdateSuccess() {
            const successDiv = document.createElement('div');
            successDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: #4CAF50; color: white; padding: 20px; border-radius: 8px; 
                     z-index: 10001; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <h3>âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°å®Œäº†</h3>
                    <p>æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ</p>
                    <button onclick="this.parentElement.remove(); location.reload();" 
                            style="background: white; color: #4CAF50; border: none; 
                                   padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
                    </button>
                </div>
            `;
            document.body.appendChild(successDiv);
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚¨ãƒ©ãƒ¼
        function showCacheUpdateError() {
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: #f44336; color: white; padding: 20px; border-radius: 8px; 
                     z-index: 10001; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <h3>âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ã‚¨ãƒ©ãƒ¼</h3>
                    <p>æ‰‹å‹•ã§ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</p>
                    <button onclick="this.parentElement.remove(); location.reload();" 
                            style="background: white; color: #f44336; border: none; 
                                   padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        å†èª­ã¿è¾¼ã¿
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
        }
        
        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (pwaPrompt) {
                pwaPrompt.style.display = 'block';
                updateDebugInfo('PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º');
            }
        });
        
        // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œ
        window.addEventListener('appinstalled', () => {
            if (pwaPrompt) {
                pwaPrompt.style.display = 'none';
            }
            updateDebugInfo('PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†');
            setTimeout(() => {
                checkAndRequestNotificationPermission();
            }, 1000);
        });
        
        // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³
        if (installBtn) {
            installBtn.addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            updateDebugInfo('PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰¿è«¾');
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }

        // é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        async function requestNotificationPermission() {
            try {
                console.log('requestNotificationPermission started');
                if ('Notification' in window) {
                    console.log('Notification API available, permission:', Notification.permission);
                    const shouldRequest = confirm(
                        'OnaRealã‚¢ãƒ—ãƒªã‹ã‚‰ã®é€šçŸ¥ã‚’å—ã‘å–ã‚Šã¾ã™ã‹ï¼Ÿ\n\n' +
                        'â€¢ æ–°ã—ã„æŠ•ç¨¿ã®é€šçŸ¥\n' +
                        'â€¢ é‡è¦ãªæ›´æ–°æƒ…å ±\n' +
                        'â€¢ ãã®ä»–ã®ãŠçŸ¥ã‚‰ã›\n\n' +
                        'ã€ŒOKã€ã‚’æŠ¼ã™ã¨é€šçŸ¥ã®è¨±å¯ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚'
                    );
                    console.log('shouldRequest:', shouldRequest);
                    if (shouldRequest) {
                        const permission = await Notification.requestPermission();
                        console.log('Notification permission result:', permission);
                        updateDebugInfo(`é€šçŸ¥è¨±å¯çµæœ: ${permission}`);
                        if (permission === 'granted') {
                            console.log('Notification permission granted');
                            showNotificationSuccess();
                            if (window.globalNotificationManager) {
                                console.log('Initializing globalNotificationManager');
                                await window.globalNotificationManager.initialize();
                            }
                        } else if (permission === 'denied') {
                            console.log('Notification permission denied');
                            showNotificationDeniedPrompt();
                        }
                    }
                } else {
                    console.error('Notification API not available. Ensure PWA is added to home screen.');
                    updateDebugInfo('ã‚¨ãƒ©ãƒ¼: Notification APIæœªã‚µãƒãƒ¼ãƒˆ');
                }
            } catch (error) {
                console.error('é€šçŸ¥è¨±å¯ã‚¨ãƒ©ãƒ¼:', error);
                updateDebugInfo(`é€šçŸ¥è¨±å¯ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // é€šçŸ¥è¨±å¯æˆåŠŸ
        function showNotificationSuccess() {
            const successDiv = document.createElement('div');
            successDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: #4CAF50; color: white; padding: 20px; border-radius: 8px; 
                     z-index: 10001; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <h3>âœ… é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ</h3>
                    <p>æ–°ã—ã„æŠ•ç¨¿ã‚„ãŠçŸ¥ã‚‰ã›ã‚’ãŠå±Šã‘ã—ã¾ã™</p>
                    <button onclick="this.parentElement.remove()" 
                            style="background: white; color: #4CAF50; border: none; 
                                   padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            `;
            document.body.appendChild(successDiv);
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 3000);
        }

        // é€šçŸ¥è¨±å¯æ‹’å¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        function showNotificationDeniedPrompt() {
            const deniedPrompt = document.createElement('div');
            deniedPrompt.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                     background: #f44336; color: white; padding: 20px; border-radius: 8px; 
                     z-index: 10001; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <h3>âŒ é€šçŸ¥ãŒç„¡åŠ¹ã§ã™</h3>
                    <p>iPhoneã®ã€Œè¨­å®šã€>ã€ŒSafariã€>ã€Œé€šçŸ¥ã€ã‹ã‚‰OnaRealã®é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚</p>
                    <button onclick="this.parentElement.remove()" 
                            style="background: white; color: #f44336; border: none; 
                                   padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        é–‰ã˜ã‚‹
                    </button>
                </div>
            `;
            document.body.appendChild(deniedPrompt);
            setTimeout(() => {
                if (deniedPrompt.parentElement) {
                    deniedPrompt.remove();
                }
            }, 10000);
        }

        // é€šçŸ¥è¨±å¯ãƒã‚§ãƒƒã‚¯
        function checkAndRequestNotificationPermission() {
            updateDebugInfo();
            console.log('é€šçŸ¥è¨±å¯ãƒã‚§ãƒƒã‚¯é–‹å§‹', {
                state: localStorage.getItem('state'),
                notificationRequested: localStorage.getItem('notificationRequested'),
                notificationSupported: 'Notification' in window,
                permission: Notification?.permission,
                isStandalone: window.navigator.standalone
            });
            
            if (!window.matchMedia('(display-mode: standalone)').matches && !window.navigator.standalone) {
                console.warn('PWAãŒãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é€šçŸ¥ãŒå‹•ä½œã—ã¾ã›ã‚“ã€‚');
                if (pwaPrompt) {
                    pwaPrompt.style.display = 'block';
                }
                updateDebugInfo('PWAæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }
            
            if ('Notification' in window) {
                if (Notification.permission === 'denied') {
                    // æ‹’å¦æ™‚ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º
                    showNotificationDeniedPrompt();
                    updateDebugInfo('é€šçŸ¥æ‹’å¦: è¨­å®šã‹ã‚‰æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
                } else if (Notification.permission === 'default') {
                    // æœªè¨±å¯æ™‚ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¡¨ç¤º
                    const notificationPrompt = document.getElementById('notification-prompt');
                    if (notificationPrompt) {
                        notificationPrompt.style.display = 'block';
                        const notificationBtn = document.getElementById('notification-btn');
                        if (notificationBtn) {
                            notificationBtn.addEventListener('click', () => {
                                console.log('é€šçŸ¥è¨±å¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                                requestNotificationPermission();
                                localStorage.setItem('notificationRequested', 'true');
                                notificationPrompt.style.display = 'none';
                                updateDebugInfo('é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå®Ÿè¡Œ');
                            }, { once: true });
                        } else {
                            console.error('é€šçŸ¥ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                            updateDebugInfo('ã‚¨ãƒ©ãƒ¼: é€šçŸ¥ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        }
                    } else {
                        console.error('é€šçŸ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        updateDebugInfo('ã‚¨ãƒ©ãƒ¼: é€šçŸ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                } else if (Notification.permission === 'granted') {
                    console.log('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™');
                    updateDebugInfo('é€šçŸ¥è¨±å¯æ¸ˆã¿');
                    if (window.globalNotificationManager) {
                        window.globalNotificationManager.initialize();
                    }
                }
            } else {
                console.error('Notification APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                updateDebugInfo('ã‚¨ãƒ©ãƒ¼: Notification APIæœªã‚µãƒãƒ¼ãƒˆ');
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
        function updateDebugInfo(message = '') {
            const debugContent = document.getElementById('debug-content');
            if (debugContent) {
                const state = localStorage.getItem('state') || 'æœªè¨­å®š';
                const notificationRequested = localStorage.getItem('notificationRequested') || 'æœªè¨­å®š';
                const notificationPermission = 'Notification' in window ? Notification.permission : 'æœªã‚µãƒãƒ¼ãƒˆ';
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isStandalone = window.navigator.standalone === true;
                const serviceWorkerState = swRegistration?.active ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : (swRegistration?.installing ? 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­' : 'æœªç™»éŒ²');
                
                debugContent.innerHTML = `
                    state: ${state}<br>
                    notificationRequested: ${notificationRequested}<br>
                    Notification.permission: ${notificationPermission}<br>
                    iOS: ${isIOS}<br>
                    PWA Standalone: ${isStandalone}<br>
                    Service Worker: ${serviceWorkerState}<br>
                    ${message ? `ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${message}<br>` : ''}
                    User Agent: ${navigator.userAgent.substring(0, 50)}...
                `;
            }
        }
        
        // é–‹ç™ºç’°å¢ƒã§ã®åˆ¶å¾¡ãƒ‘ãƒãƒ«
        function setupDevelopmentControls() {
            if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
                const devPanel = document.createElement('div');
                devPanel.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 10px;
                    border-radius: 8px;
                    font-size: 12px;
                    z-index: 10000;
                    display: none;
                `;
                devPanel.innerHTML = `
                    <div style="margin-bottom: 8px;">
                        <strong>Service Workeråˆ¶å¾¡</strong>
                    </div>
                    <button onclick="forceServiceWorkerUpdate()" style="margin: 2px; padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        å¼·åˆ¶æ›´æ–°
                    </button>
                    <button onclick="skipServiceWorkerWaiting()" style="margin: 2px; padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        å³åº§ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                    </button>
                    <button onclick="checkUpdateOnStart()" style="margin: 2px; padding: 4px 8px; background: #ffc107; color: black; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        èµ·å‹•æ™‚æ›´æ–°ãƒã‚§ãƒƒã‚¯
                    </button>
                    <button onclick="requestNotificationPermission()" style="margin: 2px; padding: 4px 8px; background: #e91e63; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        é€šçŸ¥è¨±å¯ãƒ†ã‚¹ãƒˆ
                    </button>
                    <button onclick="checkAndRequestNotificationPermission()" style="margin: 2px; padding: 4px 8px; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        é€šçŸ¥ãƒã‚§ãƒƒã‚¯
                    </button>
                    <button onclick="toggleDevPanel()" style="margin: 2px; padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        é–‰ã˜ã‚‹
                    </button>
                `;
                document.body.appendChild(devPanel);
                
                const devButton = document.createElement('button');
                devButton.textContent = 'ğŸ”§';
                devButton.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    background: #007bff;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    font-size: 16px;
                    cursor: pointer;
                    z-index: 10001;
                `;
                devButton.onclick = toggleDevPanel;
                document.body.appendChild(devButton);
                
                window.devPanel = devPanel;
            }
        }
        
        function toggleDevPanel() {
            if (window.devPanel) {
                window.devPanel.style.display = window.devPanel.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function forceServiceWorkerUpdate() {
            if (swRegistration) {
                swRegistration.update();
                updateDebugInfo('Service Workeræ›´æ–°é–‹å§‹');
            }
        }
        
        function skipServiceWorkerWaiting() {
            if (swRegistration && swRegistration.waiting) {
                swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
                updateDebugInfo('Service Workerå³åº§ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–');
            }
        }
        
        function checkUpdateOnStart() {
            if (swRegistration) {
                swRegistration.active.postMessage({ type: 'CHECK_UPDATE_ON_START' });
                updateDebugInfo('èµ·å‹•æ™‚æ›´æ–°ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ');
            }
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await unregisterAllServiceWorkers(); // ç«¶åˆé˜²æ­¢
            await registerServiceWorker();
            setupDevelopmentControls();
            checkAndRequestNotificationPermission();
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.forceCacheUpdate = forceCacheUpdate;
        window.updateApp = updateApp;
        window.forceServiceWorkerUpdate = forceServiceWorkerUpdate;
        window.skipServiceWorkerWaiting = skipServiceWorkerWaiting;
        window.checkUpdateOnStart = checkUpdateOnStart;
    </script>
</body>
</html>
